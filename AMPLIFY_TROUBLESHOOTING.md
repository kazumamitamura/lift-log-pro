# AWS Amplify トラブルシューティングガイド

## 🔴 よくある問題と解決策

### 1. ページが表示されない（白い画面）

**原因**: 
- 環境変数が設定されていない
- ビルドエラーが発生している
- Next.jsの設定が不適切

**解決策**:

1. **環境変数の確認**
   - Amplifyコンソール → 「アプリケーションの設定」→「環境変数」
   - 以下の変数が設定されているか確認：
     ```
     NEXT_PUBLIC_SUPABASE_URL
     NEXT_PUBLIC_SUPABASE_ANON_KEY
     SUPABASE_SERVICE_ROLE_KEY
     OPENAI_API_KEY
     ```

2. **ビルドログの確認**
   - Amplifyコンソール → 「デプロイ」タブ
   - 最新のデプロイを選択
   - 「ビルドログ」を確認
   - エラーメッセージを確認

3. **再デプロイ**
   - 環境変数を設定した後、必ず再デプロイを実行

### 2. ビルドエラー: "Module not found"

**原因**: 依存関係が正しくインストールされていない

**解決策**:

1. `package.json` を確認
2. `package-lock.json` がコミットされているか確認
3. ビルドログで `npm ci` が成功しているか確認

### 3. ビルドエラー: TypeScriptエラー

**原因**: TypeScriptの型エラー

**解決策**:

1. ローカルで確認：
   ```bash
   npm run build
   ```
2. エラーを修正
3. コミットして再デプロイ

### 4. APIルートが404エラー

**原因**: Next.jsのAPIルートが正しくビルドされていない

**解決策**:

1. `app/api/` ディレクトリの構造を確認
2. ビルドログでAPIルートが認識されているか確認
3. `next.config.ts` の設定を確認

### 5. 環境変数が読み込まれない

**原因**: 
- `NEXT_PUBLIC_` プレフィックスが不足
- 環境変数が設定されていない
- 再デプロイしていない

**解決策**:

1. Amplifyコンソールで環境変数を確認
2. `NEXT_PUBLIC_` が必要な変数に付いているか確認
3. 再デプロイを実行

### 6. Supabase接続エラー

**原因**: 
- SupabaseのURL/キーが間違っている
- RLSポリシーの問題

**解決策**:

1. 環境変数の値を確認
2. Supabaseダッシュボードでキーを再確認
3. ブラウザのコンソールでエラーメッセージを確認

## 🔍 デバッグ手順

### ステップ1: ビルドログの確認

1. Amplifyコンソール → 「デプロイ」タブ
2. 最新のデプロイを選択
3. 「ビルドログ」を開く
4. エラーメッセージを探す

### ステップ2: ローカルでの確認

```bash
# 依存関係のインストール
npm install

# ビルドの確認
npm run build

# 本番モードで起動
npm start
```

### ステップ3: 環境変数の確認

```bash
# .env.localファイルを確認
cat .env.local

# 環境変数が正しく設定されているか確認
```

### ステップ4: ブラウザコンソールの確認

1. デプロイされたURLを開く
2. ブラウザの開発者ツールを開く（F12）
3. 「Console」タブでエラーを確認
4. 「Network」タブでAPIリクエストを確認

## 📋 チェックリスト

デプロイ前に以下を確認：

- [ ] `amplify.yml` がプロジェクトルートにある
- [ ] `package.json` に `build` スクリプトがある
- [ ] 環境変数がAmplifyコンソールで設定されている
- [ ] ローカルで `npm run build` が成功する
- [ ] TypeScriptエラーがない
- [ ] `.gitignore` に `.env.local` が含まれている（環境変数はAmplifyで設定）

## 🚀 再デプロイ手順

1. **コードをコミット・プッシュ**
   ```bash
   git add .
   git commit -m "Fix deployment issues"
   git push origin main
   ```

2. **Amplifyコンソールで再デプロイ**
   - 「デプロイ」タブ → 「再デプロイ」ボタン

3. **ビルドログを監視**
   - ビルドが成功するまで待つ
   - エラーがあれば修正

## 💡 ヒント

- 環境変数を変更した後は必ず再デプロイ
- ビルドログを必ず確認
- ローカルで動作確認してからデプロイ
- エラーメッセージをよく読む
